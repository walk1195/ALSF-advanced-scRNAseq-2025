aucMaxRank = auc_max_rank)
ensg_tumor_markers
head(cell_rankings)
ensg_tumor_markers
tumor_markers_df
ensg_tumor_markers # Looks like it dropped one duplicate
# create a vector named `ensg_tumor_markers` with just the tumor gene set
# Subset to tumor markers only
## Method 1:
tumor_markers_df <- marker_genes_df[marker_genes_df$cell_type == "tumor",]
## Method 2:
tumor_markers_df <- marker_genes_df |>
dplyr::filter(marker_genes_df$cell_type == "tumor")
# Create a vector
ensg_tumor_markers <- tumor_markers_df$gene_symbol |>
# Remove duplicates if they exist
unique()
ensg_tumor_markers # Looks like it dropped one duplicate
?GeneSet
ensg_tumor_markers <- GeneSet(ensg_tumor_markers,
setName = "tumor_marker_genes",
geneIdType = GeneSymbolIdentifier())
head(collection_df)
collection_df <- msigdbr(species = "Homo sapiens", category = "C7VAX")
collection_df <- msigdbr(species = "Homo sapiens", category = "C7")
head(collection_df)
zce
sce
rowData(sce)
nrows(collection_df)
nrow(collection_df)
test <- collection_df[which(gs_subcat == 'VAX'),]
test <- collection_df[which(collection_df$gs_subcat == 'VAX'),]
nrow(test)
collection_df <- msigdbr(species = "Homo sapiens", category = "C7")
collection_df <- collection_df[which(collection_df$gs_subcat == 'VAX'),]
head(collection_df)
collection_list <- unique(collection_df$gs_name) |>
purrr::map(
# For each gene set
\(gene_set_name) {
collection_df |>
# Subset to the rows in that gene set
dplyr::filter(gs_name == gene_set_name) |>
# Grab the Ensembl gene identifiers
dplyr::pull(gene_symbol) |>
# Create a GeneSet object
GeneSet(setName = gene_set_name,
geneIdType = SYMBOL())
}
) |>
# Turn the list of GeneSet objects into a GeneSet collection
GeneSetCollection()
collection_list <- unique(collection_df$gs_name) |>
purrr::map(
# For each gene set
\(gene_set_name) {
collection_df |>
# Subset to the rows in that gene set
dplyr::filter(gs_name == gene_set_name) |>
# Grab the Ensembl gene identifiers
dplyr::pull(gene_symbol) |>
# Create a GeneSet object
GeneSet(setName = gene_set_name,
geneIdType = SYMBOL
}
collection_list <- unique(collection_df$gs_name) |>
purrr::map(
# For each gene set
\(gene_set_name) {
collection_df |>
# Subset to the rows in that gene set
dplyr::filter(gs_name == gene_set_name) |>
# Grab the Ensembl gene identifiers
dplyr::pull(gene_symbol) |>
# Create a GeneSet object
GeneSet(setName = gene_set_name,
geneIdType = "SYMBOL")
}
) |>
# Turn the list of GeneSet objects into a GeneSet collection
GeneSetCollection()
collection_list <- unique(collection_df$gs_name) |>
purrr::map(
# For each gene set
\(gene_set_name) {
collection_df |>
# Subset to the rows in that gene set
dplyr::filter(gs_name == gene_set_name) |>
# Grab the Ensembl gene identifiers
dplyr::pull(gene_symbol) |>
# Create a GeneSet object
GeneSet(setName = gene_set_name,
geneIdType = SymbolIdentifier())
}
) |>
# Turn the list of GeneSet objects into a GeneSet collection
GeneSetCollection()
collection_list <- unique(collection_df$gs_name) |>
purrr::map(
# For each gene set
\(gene_set_name) {
collection_df |>
# Subset to the rows in that gene set
dplyr::filter(gs_name == gene_set_name) |>
# Grab the gene symbol identifiers
dplyr::pull(gene_symbol) |>
unique() |> # fixing error about duplicates
# Create a GeneSet object
GeneSet(setName = gene_set_name,
geneIdType = SymbolIdentifier())
}
) |>
# Turn the list of GeneSet objects into a GeneSet collection
GeneSetCollection()
# Change the variable names as needed
collection_cell_auc <- AUCell_run(exprMat = counts_matrix,
geneSets = collection_list,
aucMaxRank = auc_max_rank)
GeneSetCollection()
collection_list <- unique(collection_df$gs_name) |>
purrr::map(
# For each gene set
\(gene_set_name) {
collection_df |>
# Subset to the rows in that gene set
dplyr::filter(gs_name == gene_set_name) |>
# Grab the gene symbol identifiers
dplyr::pull(gene_symbol) |>
unique() |> # fixing error about duplicates
# Create a GeneSet object
GeneSet(setName = gene_set_name,
geneIdType = SymbolIdentifier())
}
) |>
# Turn the list of GeneSet objects into a GeneSet collection
GeneSetCollection()
collection_list
head(collection_list)
rownames(counts)
counts
head(rownames(counts_matrix))
rownames(counts_matrix)
ensg_tumor_markers <- GeneSet(ensg_tumor_markers,
setName = "tumor_marker_genes",
geneIdType = SymbolIdentifier())
# Setting 2 max ranks to inspect the effect of changing it
auc_max_rank <- ceiling(nrow(cell_rankings) * 0.02) # 403
cell_auc <- AUCell_calcAUC(geneSets = ensg_tumor_markers,
rankings = cell_rankings,
aucMaxRank = auc_max_rank)
auc_assignments <- AUCell_exploreThresholds(cell_auc,
plotHist = FALSE,
assignCells = TRUE)
format_auc_df <- function(cell_auc_object) { cell_auc_object@assays@data$AUC |> # start with the internal AUC table
# Transpose
t() |>
# Convert to data frame
as.data.frame() |>
# Make the barcodes a column
tibble::rownames_to_column("barcodes") |>
# If the barcode is in the list of assigned barcodes, set the value in the
# column called tumor_cell to TRUE, and set it to FALSE otherwise
dplyr::mutate(
tumor_cell = barcodes %in% auc_assignments$tumor_marker_genes$assignment
)
}
# Call function
auc_df <- format_auc_df(cell_auc)
auc_df
auc_threshold <- auc_assignments[[1]]$aucThr$selected
auc_threshold
head(auc_df)
auc_df |>
ggplot2::ggplot(
ggplot2::aes(
x = tumor_marker_genes,
color = tumor_cell,
fill = tumor_cell,
)
) +
ggplot2::geom_density(alpha = 0.2) +
# Draw a vertical dotted line showing the threshold
ggplot2::geom_vline(data = auc_threshold_df,
mapping = ggplot2::aes(xintercept = auc_threshold),
lty = 2) +
# Use a built-in theme
ggplot2::theme_bw()
auc_df |>
ggplot2::ggplot(
ggplot2::aes(
x = tumor_marker_genes,
color = tumor_cell,
fill = tumor_cell,
)
) +
ggplot2::geom_density(alpha = 0.2) +
# Draw a vertical dotted line showing the threshold
#  ggplot2::geom_vline(data = auc_threshold_df,
#                     mapping = ggplot2::aes(xintercept = auc_threshold),
#                     lty = 2) +
# Use a built-in theme
ggplot2::theme_bw()
msigdbr_collections()
?msigdbr
collection_df <- msigdbr(species = "Homo sapiens", category = "C7", subcategory = "VAX")
#collection_df <- collection_df[which(collection_df$gs_subcat == 'VAX'),]
head(collection_df)
collection_list <- unique(collection_df$gs_name) |>
purrr::map(
# For each gene set
\(gene_set_name) {
collection_df |>
# Subset to the rows in that gene set
dplyr::filter(gs_name == gene_set_name) |>
# Grab the gene symbol identifiers
dplyr::pull(gene_symbol) |>
unique() |> # fixing error about duplicates
# Create a GeneSet object
GeneSet(setName = gene_set_name,
geneIdType = SymbolIdentifier())
}
) |>
# Turn the list of GeneSet objects into a GeneSet collection
GeneSetCollection()
# Change the variable names as needed
collection_cell_auc <- AUCell_run(exprMat = counts_matrix,
geneSets = collection_list,
aucMaxRank = auc_max_rank)
collection_auc_df <- collection_cell_auc@assays@data$AUC |>
# Transpose
t() |>
# Convert to data frame
as.data.frame() |>
# Make the barcodes a column
tibble::rownames_to_column("barcodes")
collection_auc_df
auc_df
auc_df <- auc_df |>
dplyr::inner_join(
collection_auc_df,
by = "barcodes"
)
auc_output_file
readr::write_tsv(auc_df, auc_output_file)
auc_df
colnames(auc_df)
# Grab some pathways of interest
pathways_to_plot <- c("ANDERSON_BLOOD_CN54GP140_ADJUVANTED_WITH_GLA_AF_AGE_18_45YO_7DY_UP",
"BUCASAS_PBMC_FLUARIX_FLUVIRIN_CAUCASIAN_MALE_AGE_18_40YO_HIGH_RESPONDERS_1DY_TOP_FUNCTIONAL_NETWORK_POSITIVE",
"FRANCO_BLOOD_SANOFI_PASTEUR_SA_INACTIVATED_INFLUENZA_VACCINE_CORRELATED_WITH_ANTIBODY_RESPONSE_AGE_18_40YO_0DY_POSITIVE",
"HOEK_T_CELL_2011_2012_TIV_ADULT_3DY_UP",
"HOEK_B_CELL_2011_2012_TIV_ADULT_7DY_UP",
"HOFT_CD4_POSITIVE_ALPHA_BETA_MEMORY_T_CELL_BCG_VACCINE_AGE_18_45YO_56D_TOP_100_DEG_AFTER_IN_VITRO_RE_STIMULATION_UP")
?dplyr::select
# Subset df
auc_df_selected <- auc_df[,colnames(auc_df) %in% pathways_to_plot]
auc_df_selected
dim(auc_df_selected)
head(auc_df_selected)
View(auc_df_selected)
auc_df[,1:2]
head(auc_df[,1:2])
# Grab some pathways of interest
pathways_to_plot <- c("barcodes", "tumor_marker_genes", "tumor_cell",
"ANDERSON_BLOOD_CN54GP140_ADJUVANTED_WITH_GLA_AF_AGE_18_45YO_7DY_UP",
"BUCASAS_PBMC_FLUARIX_FLUVIRIN_CAUCASIAN_MALE_AGE_18_40YO_HIGH_RESPONDERS_1DY_TOP_FUNCTIONAL_NETWORK_POSITIVE",
"FRANCO_BLOOD_SANOFI_PASTEUR_SA_INACTIVATED_INFLUENZA_VACCINE_CORRELATED_WITH_ANTIBODY_RESPONSE_AGE_18_40YO_0DY_POSITIVE",
"HOEK_T_CELL_2011_2012_TIV_ADULT_3DY_UP",
"HOEK_B_CELL_2011_2012_TIV_ADULT_7DY_UP",
"HOFT_CD4_POSITIVE_ALPHA_BETA_MEMORY_T_CELL_BCG_VACCINE_AGE_18_45YO_56D_TOP_100_DEG_AFTER_IN_VITRO_RE_STIMULATION_UP")
# Subset df
auc_df_selected <- auc_df[,colnames(auc_df) %in% pathways_to_plot]
View(auc_df_selected)
# Extract colData and join with AUC data frame
coldata_df <- colData(sce) |>
as.data.frame() |>
dplyr::left_join(auc_df_selected, by = "barcodes")
colData(sce)$barcodes <- auc_df_selected$barcodes
# Extract colData and join with AUC data frame
coldata_df <- colData(sce) |>
as.data.frame() |>
dplyr::left_join(auc_df_selected, by = "barcodes")
# Add a DataFrame back to colData
colData(sce) <- DataFrame(
coldata_df,
row.names = colData(sce)$barcodes
)
# Extract colData and join with AUC data frame
coldata_df <- colData(sce_filtered) |>
as.data.frame() |>
dplyr::left_join(auc_df_selected, by = "barcodes")
colData(sce_filtered)$barcodes <- auc_df_selected$barcode
# Extract colData and join with AUC data frame
coldata_df <- colData(sce_filtered) |>
as.data.frame() |>
dplyr::left_join(auc_df_selected, by = "barcodes")
# Add a DataFrame back to colData
colData(sce_filtered) <- DataFrame(
coldata_df,
row.names = colData(sce_filtered)$barcodes
)
### Run through a quick processing
# Perform rough clustering
qclust <- scran::quickCluster(sce_filtered)
# use clusters to compute scaling factors and add to SCE object
sce_filtered <- scran::computeSumFactors(
sce_filtered,
clusters = qclust
)
# perform normalization using scaling factors
# and save as a new SCE object
normalized_sce <- scuttle::logNormCounts(sce_filtered)
# identify 2000 genes
num_genes <- 2000
# model variance, partitioning into biological and technical variation
gene_variance <- scran::modelGeneVar(normalized_sce)
# get the most variable genes
hv_genes <- scran::getTopHVGs(
gene_variance,
n = num_genes
)
# PCA
normalized_sce <- scater::runPCA(
normalized_sce,
subset_row = hv_genes,
ncomponents = 50
)
# UMAP
normalized_sce <- scater::runUMAP(
normalized_sce,
dimred = "PCA"
)
scater::plotUMAP(
sce,
color_by = "tumor_cell"
)
scater::plotUMAP(
normalized_sce,
color_by = "tumor_cell"
)
scater::plotUMAP(
normalized_sce,
color_by = "tumor_cell",
point_size = 0.5,
point_alpha = 0.2
)
scater::plotReducedDim(
sce,
dimred = "UMAP",
color_by = pathways_to_plot,
shape = "tumor_cell"
) +
ggplot2::ggtitle(stringr::str_replace_all(pathways_to_plot,
"\\_",
" "))
scater::plotReducedDim(
normalized_sce,
dimred = "UMAP",
color_by = pathways_to_plot,
shape = "tumor_cell"
) +
ggplot2::ggtitle(stringr::str_replace_all(pathways_to_plot,
"\\_",
" "))
pathways_to_plot
pathway_to_plot <- "ANDERSON_BLOOD_CN54GP140_ADJUVANTED_WITH_GLA_AF_AGE_18_45YO_7DY_UP"
scater::plotReducedDim(
normalized_sce,
dimred = "UMAP",
color_by = pathway_to_plot,
shape = "tumor_cell"
) +
ggplot2::ggtitle(stringr::str_replace_all(pathways_to_plot,
"\\_",
" "))
out_dir <- fs::path(processed_dir, glue::glue("{pathway_to_plot}.png"))
out_dir <- fs::path(processed_dir, glue::glue("{pathway_to_plot}.png"))
out_dir
ggsave(umap, file = out_dir)
ggplot2::ggsave(umap, file = out_dir)
umap <- scater::plotReducedDim(
normalized_sce,
dimred = "UMAP",
color_by = pathway_to_plot,
shape = "tumor_cell"
) +
ggplot2::ggtitle(stringr::str_replace_all(pathways_to_plot,
"\\_",
" "))
ggplot2::ggsave(umap, file = out_dir)
ggplot2::ggsave(umap, file = out_dir, dpi=400)
ggplot2::ggsave(umap, file = out_dir, dpi=400)
ggplot2::ggsave(umap, file = out_dir, dpi=400, height=5, width=7)
umap <- scater::plotReducedDim(
normalized_sce,
dimred = "UMAP",
color_by = pathway_to_plot,
shape = "tumor_cell"
) +
ggplot2::ggtitle(stringr::str_replace_all(pathways_to_plot,
"\\_",
" ")) +
ggplot2::labs(color = NULL, shape = NULL)
umap
umap <- scater::plotReducedDim(
normalized_sce,
dimred = "UMAP",
color_by = pathway_to_plot,
shape = "tumor_cell"
) +
ggplot2::ggtitle(stringr::str_replace_all(pathways_to_plot,
"\\_",
" ")) +
ggplot2::scale_color_discrete(name = NULL) +  # remove color legend title
ggplot2::scale_shape_discrete(name = NULL)    # remove shape legend title
umap
umap <- scater::plotReducedDim(
normalized_sce,
dimred = "UMAP",
color_by = pathway_to_plot,
shape = "tumor_cell"
) +
ggplot2::ggtitle(stringr::str_replace_all(pathways_to_plot,
"\\_",
" "))
umap
umap <- scater::plotReducedDim(
normalized_sce,
dimred = "UMAP",
color_by = pathway_to_plot,
shape = "tumor_cell"
) +
ggplot2::ggtitle(stringr::str_replace_all(pathways_to_plot,
"\\_",
" "))
umap + scale_fill_discrete(name = "New Legend Title")
pathway_to_plot <- "ANDERSON_BLOOD_CN54GP140_ADJUVANTED_WITH_GLA_AF_AGE_18_45YO_7DY_UP"
umap <- scater::plotReducedDim(
normalized_sce,
dimred = "UMAP",
color_by = pathway_to_plot,
shape = "tumor_cell"
) +
ggplot2::ggtitle(stringr::str_replace_all(pathways_to_plot,
"\\_",
" "))
umap + ggplot2::scale_fill_discrete(name = "New Legend Title")
out_dir <- fs::path(processed_dir, glue::glue("{pathway_to_plot}.png"))
ggplot2::ggsave(umap, file = out_dir, dpi=400, height=5, width=7)
umap <- scater::plotReducedDim(
normalized_sce,
dimred = "UMAP",
color_by = pathway_to_plot,
shape = "tumor_cell"
) +
labs(fill='Legend Title') +
ggplot2::ggtitle(stringr::str_replace_all(pathways_to_plot,
"\\_",
" "))
umap <- scater::plotReducedDim(
normalized_sce,
dimred = "UMAP",
color_by = pathway_to_plot,
shape = "tumor_cell"
) +
ggplot2::labs(fill='Legend Title') +
ggplot2::ggtitle(stringr::str_replace_all(pathways_to_plot,
"\\_",
" "))
umap
ggplot2::ggsave(umap, file = out_dir, dpi=400, height=5, width=12)
pathway_to_plot <- "HOEK_T_CELL_2011_2012_TIV_ADULT_3DY_UP"
umap <- scater::plotReducedDim(
normalized_sce,
dimred = "UMAP",
color_by = pathway_to_plot,
shape = "tumor_cell"
) +
ggplot2::ggtitle(stringr::str_replace_all(pathways_to_plot,
"\\_",
" "))
umap
out_dir <- fs::path(processed_dir, glue::glue("{pathway_to_plot}.png"))
ggplot2::ggsave(umap, file = out_dir, dpi=400, height=5, width=12)
pathway_to_plot <- "HOFT_CD4_POSITIVE_ALPHA_BETA_MEMORY_T_CELL_BCG_VACCINE_AGE_18_45YO_56D_TOP_100_DEG_AFTER_IN_VITRO_RE_STIMULATION_UP"
umap <- scater::plotReducedDim(
normalized_sce,
dimred = "UMAP",
color_by = pathway_to_plot,
shape = "tumor_cell"
) +
ggplot2::ggtitle(stringr::str_replace_all(pathways_to_plot,
"\\_",
" "))
umap
out_dir <- fs::path(processed_dir, glue::glue("{pathway_to_plot}.png"))
ggplot2::ggsave(umap, file = out_dir, dpi=400, height=5, width=12)
pathway_to_plot <- "HOEK_B_CELL_2011_2012_TIV_ADULT_7DY_UP"
umap <- scater::plotReducedDim(
normalized_sce,
dimred = "UMAP",
color_by = pathway_to_plot,
shape = "tumor_cell"
) +
ggplot2::ggtitle(stringr::str_replace_all(pathways_to_plot,
"\\_",
" "))
umap
out_dir <- fs::path(processed_dir, glue::glue("{pathway_to_plot}.png"))
ggplot2::ggsave(umap, file = out_dir, dpi=400, height=5, width=12)
out_dir
